<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìš´ì˜ì - The Challenge 100</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Pretendard', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    .header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .back-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 10px;
      color: #fff;
      text-decoration: none;
      font-weight: 600;
    }
    .back-btn:hover { background: rgba(255,255,255,0.2); }
    h1 { font-size: 28px; }

    .tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 30px;
      border-bottom: 2px solid rgba(255,255,255,0.1);
    }
    .tab {
      padding: 15px 25px;
      background: transparent;
      border: none;
      color: #a0a0c0;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
    }
    .tab:hover { color: #fff; }
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .card {
      background: rgba(255,255,255,0.05);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 20px;
    }
    .card h3 {
      font-size: 18px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .phase-control {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .phase-btn {
      padding: 12px 24px;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .phase-btn:hover { border-color: #667eea; }
    .phase-btn.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-color: transparent;
    }
    .phase-btn.danger {
      background: rgba(239, 68, 68, 0.2);
      border-color: #ef4444;
      color: #ef4444;
    }
    .phase-btn.danger:hover { background: #ef4444; color: #fff; }

    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #a0a0c0;
      font-size: 14px;
    }
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      color: #fff;
      font-size: 15px;
    }
    .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    .form-group textarea {
      min-height: 150px;
      font-family: monospace;
    }

    .btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    th {
      color: #a0a0c0;
      font-weight: 600;
      font-size: 13px;
    }
    tr:hover { background: rgba(255,255,255,0.03); }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-purple { background: rgba(102, 126, 234, 0.2); color: #667eea; }
    .badge-green { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .badge-yellow { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    .stat-item {
      background: rgba(255,255,255,0.03);
      padding: 20px;
      border-radius: 15px;
      text-align: center;
    }
    .stat-item .value {
      font-size: 28px;
      font-weight: 700;
      color: #667eea;
    }
    .stat-item .label {
      font-size: 13px;
      color: #a0a0c0;
      margin-top: 5px;
    }

    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 30px;
      background: #667eea;
      border-radius: 12px;
      font-weight: 600;
      z-index: 1000;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <a href="/" class="back-btn">â† í™ˆ</a>
      <h1>âš™ï¸ ìš´ì˜ì í˜ì´ì§€</h1>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="showTab('overview')">ê°œìš”</button>
      <button class="tab" onclick="showTab('participants')">ì°¸ê°€ì ê´€ë¦¬</button>
      <button class="tab" onclick="showTab('voting')">íˆ¬í‘œ í˜„í™©</button>
      <button class="tab" onclick="showTab('teams')">íŒ€ ê´€ë¦¬</button>
    </div>

    <!-- ê°œìš” íƒ­ -->
    <div id="tab-overview" class="tab-content active">
      <div class="card">
        <h3>ğŸ“Š í˜„ì¬ ìƒíƒœ</h3>
        <div class="stats-row">
          <div class="stat-item">
            <div class="value" id="statParticipants">-</div>
            <div class="label">ì „ì²´ ì°¸ê°€ì</div>
          </div>
          <div class="stat-item">
            <div class="value" id="statVoted">-</div>
            <div class="label">íˆ¬í‘œ ì™„ë£Œ</div>
          </div>
          <div class="stat-item">
            <div class="value" id="statLeaders">-</div>
            <div class="label">ì„ ì •ëœ ë¦¬ë”</div>
          </div>
          <div class="stat-item">
            <div class="value" id="statTeams">-</div>
            <div class="label">êµ¬ì„±ëœ íŒ€</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>ğŸ® ë‹¨ê³„ ê´€ë¦¬</h3>
        <p style="color: #a0a0c0; margin-bottom: 20px;">í˜„ì¬ ë‹¨ê³„: <span id="currentPhase" class="badge badge-purple">-</span></p>
        <div class="phase-control">
          <button class="phase-btn" onclick="setPhase('setup')">1. ì‚¬ì „ ì¤€ë¹„</button>
          <button class="phase-btn" onclick="setPhase('voting')">2. íˆ¬í‘œ ì‹œì‘</button>
          <button class="phase-btn" onclick="selectLeaders()">3. ë¦¬ë” ì„ ì •</button>
          <button class="phase-btn" onclick="setPhase('team_forming')">4. íŒ€ êµ¬ì„±</button>
          <button class="phase-btn" onclick="setPhase('confirmed')">5. ìµœì¢… í™•ì •</button>
        </div>
      </div>
    </div>

    <!-- ì°¸ê°€ì ê´€ë¦¬ íƒ­ -->
    <div id="tab-participants" class="tab-content">
      <div class="card">
        <h3>ğŸ“¥ ì°¸ê°€ì Import</h3>
        <p style="color: #a0a0c0; margin-bottom: 15px;">
          CSV í˜•ì‹: name, company, email, phone, problem_tag (ì²« ì¤„ì€ í—¤ë”)
        </p>
        <div class="form-group">
          <label>CSV ë°ì´í„° ë¶™ì—¬ë„£ê¸°</label>
          <textarea id="csvInput" placeholder="name,company,email,phone,problem_tag
í™ê¸¸ë™,ABCíšŒì‚¬,hong@example.com,010-1234-5678,í™˜ê²½ë¬¸ì œ
ê¹€ì² ìˆ˜,XYZê¸°ì—…,kim@example.com,010-9876-5432,êµìœ¡í˜ì‹ "></textarea>
        </div>
        <button class="btn" onclick="importParticipants()">Import</button>
      </div>

      <div class="card">
        <h3>ğŸ‘¥ ì°¸ê°€ì ëª©ë¡</h3>
        <div id="participantsTable">
          <table>
            <thead>
              <tr>
                <th>ì´ë¦„</th>
                <th>ì†Œì†</th>
                <th>ë¬¸ì œ íƒœê·¸</th>
                <th>ë“í‘œ</th>
                <th>ë¦¬ë”</th>
              </tr>
            </thead>
            <tbody id="participantsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- íˆ¬í‘œ í˜„í™© íƒ­ -->
    <div id="tab-voting" class="tab-content">
      <div class="card">
        <h3>ğŸ“Š ë¬¸ì œ íƒœê·¸ë³„ íˆ¬í‘œ í˜„í™©</h3>
        <div id="votingStats"></div>
      </div>
    </div>

    <!-- íŒ€ ê´€ë¦¬ íƒ­ -->
    <div id="tab-teams" class="tab-content">
      <div class="card">
        <h3>ğŸ‘¥ íŒ€ ëª©ë¡</h3>
        <div id="teamsTable">
          <table>
            <thead>
              <tr>
                <th>ë¬¸ì œ íƒœê·¸</th>
                <th>ë¦¬ë”</th>
                <th>íŒ€ì› ìˆ˜</th>
                <th>ìƒíƒœ</th>
                <th>ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody id="teamsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="toast hidden" id="toast"></div>

  <script>
    const EVENT_ID = 1;

    function showTab(name) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector(`.tab[onclick="showTab('${name}')"]`).classList.add('active');
      document.getElementById(`tab-${name}`).classList.add('active');

      if (name === 'participants') loadParticipants();
      if (name === 'voting') loadVotingStats();
      if (name === 'teams') loadTeams();
    }

    async function loadOverview() {
      try {
        // ì´ë²¤íŠ¸ ì •ë³´
        const eventRes = await fetch(`/api/events/${EVENT_ID}`);
        const eventData = await eventRes.json();
        if (eventData.success) {
          document.getElementById('currentPhase').textContent = eventData.event.phase;
        }

        // ì°¸ê°€ì ìˆ˜
        const partRes = await fetch(`/api/events/${EVENT_ID}/participants`);
        const partData = await partRes.json();
        if (partData.success) {
          document.getElementById('statParticipants').textContent = partData.participants.length;
          document.getElementById('statLeaders').textContent = partData.participants.filter(p => p.is_leader).length;
        }

        // íŒ€ ìˆ˜
        const teamRes = await fetch(`/api/events/${EVENT_ID}/teams`);
        const teamData = await teamRes.json();
        if (teamData.success) {
          document.getElementById('statTeams').textContent = teamData.teams.length;
        }

        document.getElementById('statVoted').textContent = '-'; // TODO: íˆ¬í‘œ ì™„ë£Œì ìˆ˜

      } catch (e) {
        console.error(e);
      }
    }

    async function setPhase(phase) {
      try {
        const res = await fetch(`/api/events/${EVENT_ID}/phase`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phase })
        });
        const data = await res.json();
        if (data.success) {
          showToast(`ë‹¨ê³„ê°€ ${phase}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`);
          loadOverview();
        } else {
          showToast(data.error);
        }
      } catch (e) {
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    }

    async function selectLeaders() {
      if (!confirm('íˆ¬í‘œ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¦¬ë”ë¥¼ ìë™ ì„ ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        const res = await fetch(`/api/events/${EVENT_ID}/leaders/select`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          showToast(`${data.leader_count}ëª…ì˜ ë¦¬ë”ê°€ ì„ ì •ë˜ì—ˆìŠµë‹ˆë‹¤`);
          loadOverview();
        } else {
          showToast(data.error);
        }
      } catch (e) {
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    }

    async function importParticipants() {
      const csv = document.getElementById('csvInput').value.trim();
      if (!csv) {
        showToast('CSV ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      const lines = csv.split('\n');
      const headers = lines[0].split(',').map(h => h.trim());
      const participants = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        if (values.length < 2) continue;

        const obj = {};
        headers.forEach((h, idx) => obj[h] = values[idx] || '');
        participants.push(obj);
      }

      try {
        const res = await fetch(`/api/events/${EVENT_ID}/participants/import`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ participants })
        });
        const data = await res.json();
        if (data.success) {
          showToast(`${data.count}ëª… ë“±ë¡ ì™„ë£Œ`);
          document.getElementById('csvInput').value = '';
          loadParticipants();
          loadOverview();
        } else {
          showToast(data.error);
        }
      } catch (e) {
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    }

    async function loadParticipants() {
      try {
        const res = await fetch(`/api/events/${EVENT_ID}/participants`);
        const data = await res.json();

        if (data.success) {
          const tbody = document.getElementById('participantsBody');
          tbody.innerHTML = data.participants.map(p => `
            <tr>
              <td>${p.name}</td>
              <td>${p.company || '-'}</td>
              <td><span class="badge badge-purple">${p.problem_tag || '-'}</span></td>
              <td>${p.vote_count || 0}</td>
              <td>${p.is_leader ? '<span class="badge badge-green">ë¦¬ë”</span>' : '-'}</td>
            </tr>
          `).join('');
        }
      } catch (e) {
        console.error(e);
      }
    }

    async function loadVotingStats() {
      try {
        const res = await fetch(`/api/events/${EVENT_ID}/problem-tags`);
        const data = await res.json();

        if (data.success) {
          const container = document.getElementById('votingStats');
          let html = '<div class="stats-row">';
          for (const tag of data.tags) {
            html += `
              <div class="stat-item" style="cursor:pointer" onclick="showTagVotes('${tag.problem_tag}')">
                <div class="value">${tag.count}</div>
                <div class="label">${tag.problem_tag}</div>
              </div>
            `;
          }
          html += '</div>';
          container.innerHTML = html;
        }
      } catch (e) {
        console.error(e);
      }
    }

    async function showTagVotes(tag) {
      try {
        const res = await fetch(`/api/events/${EVENT_ID}/votes/results?problem_tag=${encodeURIComponent(tag)}`);
        const data = await res.json();

        if (data.success) {
          const list = data.results.map(p => `${p.name} (${p.company || '-'}): ${p.vote_count}í‘œ`).join('\n');
          alert(`[${tag}] íˆ¬í‘œ í˜„í™©\n\n${list}`);
        }
      } catch (e) {
        console.error(e);
      }
    }

    async function loadTeams() {
      try {
        const res = await fetch(`/api/events/${EVENT_ID}/teams`);
        const data = await res.json();

        if (data.success) {
          const tbody = document.getElementById('teamsBody');
          tbody.innerHTML = data.teams.map(t => `
            <tr>
              <td><span class="badge badge-purple">${t.problem_tag || '-'}</span></td>
              <td>${t.leader_name}</td>
              <td>${t.member_count || 1} / 4</td>
              <td><span class="badge ${t.status === 'confirmed' ? 'badge-green' : 'badge-yellow'}">${t.status}</span></td>
              <td>
                ${t.status !== 'confirmed' ? `<button class="btn" style="padding:6px 12px; font-size:12px;" onclick="confirmTeam(${t.id})">í™•ì •</button>` : '-'}
              </td>
            </tr>
          `).join('');
        }
      } catch (e) {
        console.error(e);
      }
    }

    async function confirmTeam(teamId) {
      try {
        const res = await fetch(`/api/events/${EVENT_ID}/teams/${teamId}/confirm`, { method: 'PATCH' });
        const data = await res.json();
        if (data.success) {
          showToast('íŒ€ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
          loadTeams();
        } else {
          showToast(data.error);
        }
      } catch (e) {
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    }

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    // ì´ˆê¸° ë¡œë“œ
    loadOverview();
  </script>
</body>
</html>
