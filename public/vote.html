<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¦¬ë” íˆ¬í‘œ - The Challenge 100</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Pretendard', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1000px; margin: 0 auto; }
    .header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .back-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 10px;
      color: #fff;
      text-decoration: none;
      font-weight: 600;
    }
    .back-btn:hover { background: rgba(255,255,255,0.2); }
    h1 { font-size: 28px; }

    .auth-section {
      background: rgba(255,255,255,0.05);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      text-align: center;
    }
    .auth-section input {
      width: 100%;
      max-width: 400px;
      padding: 15px 20px;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      color: #fff;
      font-size: 16px;
      margin-bottom: 15px;
    }
    .auth-section input:focus {
      outline: none;
      border-color: #667eea;
    }
    .auth-section button {
      padding: 15px 40px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    .vote-info {
      background: rgba(102, 126, 234, 0.1);
      border: 1px solid rgba(102, 126, 234, 0.3);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 25px;
    }
    .vote-info h3 { color: #667eea; margin-bottom: 10px; }
    .vote-info p { color: #a0a0c0; font-size: 14px; }

    .my-group {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 15px 20px;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .my-group-tag {
      background: linear-gradient(135deg, #667eea, #764ba2);
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
    }

    .selected-count {
      background: #1a1a2e;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .selected-count .count {
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
    }
    .submit-btn {
      padding: 12px 30px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .candidates-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
    }
    .candidate-card {
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .candidate-card:hover {
      border-color: rgba(102, 126, 234, 0.5);
    }
    .candidate-card.selected {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }
    .candidate-card.myself {
      opacity: 0.5;
      cursor: not-allowed;
      border-style: dashed;
    }
    .candidate-name {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    .candidate-company {
      font-size: 14px;
      color: #a0a0c0;
      margin-bottom: 10px;
    }
    .candidate-votes {
      display: inline-block;
      padding: 5px 12px;
      background: rgba(102, 126, 234, 0.2);
      border-radius: 15px;
      font-size: 13px;
      color: #667eea;
    }
    .check-icon {
      float: right;
      font-size: 24px;
    }

    .hidden { display: none; }

    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 30px;
      background: #667eea;
      border-radius: 12px;
      font-weight: 600;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <a href="/" class="back-btn">â† í™ˆ</a>
      <h1>ğŸ—³ï¸ ë¦¬ë” íˆ¬í‘œ</h1>
    </div>

    <!-- ì¸ì¦ ì„¹ì…˜ -->
    <div class="auth-section" id="authSection">
      <h2 style="margin-bottom: 20px;">ë³¸ì¸ í™•ì¸</h2>
      <p style="color: #a0a0c0; margin-bottom: 20px;">ë“±ë¡ëœ ì´ë©”ì¼ ë˜ëŠ” ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
      <input type="text" id="authInput" placeholder="ì´ë©”ì¼ ë˜ëŠ” ì „í™”ë²ˆí˜¸">
      <br>
      <button onclick="authenticate()">í™•ì¸</button>
    </div>

    <!-- íˆ¬í‘œ ì„¹ì…˜ -->
    <div id="voteSection" class="hidden">
      <div class="vote-info">
        <h3>ğŸ—³ï¸ ë¦¬ë” íˆ¬í‘œ ì•ˆë‚´</h3>
        <p>ê°™ì€ ë¬¸ì œ íƒœê·¸ ê·¸ë£¹ ë‚´ì—ì„œ "ì´ ì‚¬ëŒì´ ë¦¬ë” í–ˆìœ¼ë©´ ì¢‹ê² ë‹¤" ì‹¶ì€ ë¶„ 3ëª…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.<br>
        ë“í‘œ ìƒìœ„ìê°€ ë¦¬ë”ë¡œ ì„ ì •ë˜ì–´ íŒ€ì„ ì´ëŒê²Œ ë©ë‹ˆë‹¤.</p>
      </div>

      <div class="my-group">
        <span>ë‚´ ê´€ì‹¬ ë¬¸ì œ:</span>
        <span class="my-group-tag" id="myGroupTag">-</span>
        <span id="myName" style="margin-left: auto; color: #a0a0c0;"></span>
      </div>

      <div class="selected-count">
        <div>
          <span style="color: #a0a0c0;">ì„ íƒí•œ í›„ë³´:</span>
          <span class="count"><span id="selectedCount">0</span> / 3</span>
        </div>
        <button class="submit-btn" id="submitBtn" onclick="submitVotes()" disabled>íˆ¬í‘œí•˜ê¸°</button>
      </div>

      <div class="candidates-grid" id="candidatesGrid">
        <!-- í›„ë³´ ì¹´ë“œë“¤ -->
      </div>
    </div>
  </div>

  <div class="toast hidden" id="toast"></div>

  <script>
    const EVENT_ID = 1;
    let currentUser = null;
    let selectedCandidates = [];

    async function authenticate() {
      const input = document.getElementById('authInput').value.trim();
      if (!input) {
        showToast('ì´ë©”ì¼ ë˜ëŠ” ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      try {
        const res = await fetch(`/api/events/${EVENT_ID}/participants`);
        const data = await res.json();

        if (data.success) {
          const user = data.participants.find(p =>
            p.email === input || p.phone === input || p.name === input
          );

          if (user) {
            currentUser = user;
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('voteSection').classList.remove('hidden');
            document.getElementById('myGroupTag').textContent = user.problem_tag || 'ë¯¸ì§€ì •';
            document.getElementById('myName').textContent = user.name;
            loadCandidates();
            loadMyVotes();
          } else {
            showToast('ë“±ë¡ëœ ì°¸ê°€ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
          }
        }
      } catch (e) {
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    }

    async function loadCandidates() {
      if (!currentUser) return;

      try {
        const res = await fetch(`/api/events/${EVENT_ID}/participants?problem_tag=${encodeURIComponent(currentUser.problem_tag)}`);
        const data = await res.json();

        if (data.success) {
          renderCandidates(data.participants);
        }
      } catch (e) {
        showToast('í›„ë³´ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      }
    }

    async function loadMyVotes() {
      if (!currentUser) return;

      try {
        const res = await fetch(`/api/events/${EVENT_ID}/votes/${currentUser.id}`);
        const data = await res.json();

        if (data.success && data.voted_for) {
          selectedCandidates = data.voted_for;
          updateUI();
        }
      } catch (e) {
        console.error(e);
      }
    }

    function renderCandidates(candidates) {
      const grid = document.getElementById('candidatesGrid');
      grid.innerHTML = candidates.map(c => {
        const isMyself = c.id === currentUser.id;
        const isSelected = selectedCandidates.includes(c.id);

        return `
          <div class="candidate-card ${isSelected ? 'selected' : ''} ${isMyself ? 'myself' : ''}"
               onclick="${isMyself ? '' : `toggleCandidate(${c.id})`}"
               data-id="${c.id}">
            ${isSelected ? '<span class="check-icon">âœ“</span>' : ''}
            <div class="candidate-name">${c.name}</div>
            <div class="candidate-company">${c.company || '-'}</div>
            <span class="candidate-votes">ë“í‘œ ${c.vote_count || 0}</span>
            ${isMyself ? '<span style="float:right; color:#a0a0c0; font-size:12px;">ë‚˜</span>' : ''}
          </div>
        `;
      }).join('');
    }

    function toggleCandidate(id) {
      const idx = selectedCandidates.indexOf(id);
      if (idx >= 0) {
        selectedCandidates.splice(idx, 1);
      } else {
        if (selectedCandidates.length >= 3) {
          showToast('ìµœëŒ€ 3ëª…ê¹Œì§€ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
          return;
        }
        selectedCandidates.push(id);
      }
      updateUI();
    }

    function updateUI() {
      document.getElementById('selectedCount').textContent = selectedCandidates.length;
      document.getElementById('submitBtn').disabled = selectedCandidates.length === 0;

      document.querySelectorAll('.candidate-card').forEach(card => {
        const id = parseInt(card.dataset.id);
        const isSelected = selectedCandidates.includes(id);
        card.classList.toggle('selected', isSelected);

        const checkIcon = card.querySelector('.check-icon');
        if (isSelected && !checkIcon) {
          card.insertAdjacentHTML('afterbegin', '<span class="check-icon">âœ“</span>');
        } else if (!isSelected && checkIcon) {
          checkIcon.remove();
        }
      });
    }

    async function submitVotes() {
      if (!currentUser || selectedCandidates.length === 0) return;

      try {
        const res = await fetch(`/api/events/${EVENT_ID}/votes`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            voter_id: currentUser.id,
            candidate_ids: selectedCandidates
          })
        });

        const data = await res.json();
        if (data.success) {
          showToast('íˆ¬í‘œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
          loadCandidates(); // ë“í‘œìˆ˜ ì—…ë°ì´íŠ¸
        } else {
          showToast(data.error || 'íˆ¬í‘œ ì‹¤íŒ¨');
        }
      } catch (e) {
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    }

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }
  </script>
</body>
</html>
